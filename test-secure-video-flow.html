<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®‰å…¨è§†é¢‘è®¿é—®æµç¨‹æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .step {
            border-left: 4px solid #007bff;
            padding-left: 15px;
            margin-bottom: 20px;
        }
        .step h3 {
            color: #007bff;
            margin-top: 0;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .result {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-top: 10px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            border-color: #28a745;
            background-color: #d4edda;
        }
        .error {
            border-color: #dc3545;
            background-color: #f8d7da;
        }
        .video-item {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .video-item:hover {
            background-color: #f8f9fa;
        }
        .video-item.selected {
            background-color: #e3f2fd;
            border-color: #2196f3;
        }
        .episode-item {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 8px;
            margin: 5px 0;
            cursor: pointer;
        }
        .episode-item:hover {
            background-color: #e9ecef;
        }
        .security-info {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
        }
        .security-info h4 {
            color: #856404;
            margin-top: 0;
        }
        .flow-diagram {
            text-align: center;
            margin: 20px 0;
        }
        .flow-step {
            display: inline-block;
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            margin: 0 5px;
            position: relative;
        }
        .flow-step::after {
            content: 'â†’';
            position: absolute;
            right: -20px;
            color: #007bff;
            font-weight: bold;
        }
        .flow-step:last-child::after {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”’ å®‰å…¨è§†é¢‘è®¿é—®æµç¨‹æµ‹è¯•</h1>
        <p>æœ¬é¡µé¢æ¼”ç¤ºå¦‚ä½•å®‰å…¨åœ°ä»ç­›é€‰ç»“æœè·å–è§†é¢‘æ’­æ”¾åœ°å€ï¼Œå±•ç¤ºå®Œæ•´çš„æ•°æ®ä¿æŠ¤æµç¨‹ã€‚</p>
        
        <div class="security-info">
            <h4>ğŸ›¡ï¸ å®‰å…¨æœºåˆ¶è¯´æ˜</h4>
            <ul>
                <li><strong>JWTèº«ä»½éªŒè¯</strong>ï¼šæ‰€æœ‰APIè°ƒç”¨éƒ½éœ€è¦æœ‰æ•ˆçš„JWTä»¤ç‰Œ</li>
                <li><strong>UUIDæ ‡è¯†ç¬¦</strong>ï¼šä½¿ç”¨UUIDæ›¿ä»£æ•°å­—IDï¼Œé˜²æ­¢æšä¸¾æ”»å‡»</li>
                <li><strong>è®¿é—®å¯†é’¥</strong>ï¼šæ’­æ”¾åœ°å€é€šè¿‡32ä½éšæœºå¯†é’¥ä¿æŠ¤</li>
                <li><strong>åˆ†å±‚è®¿é—®</strong>ï¼šå…ƒæ•°æ®ä¸æ’­æ”¾åœ°å€åˆ†ç¦»ï¼Œéœ€è¦å¤šæ­¥éªŒè¯</li>
            </ul>
        </div>
        
        <div class="flow-diagram">
            <div class="flow-step">ç­›é€‰æ•°æ®</div>
            <div class="flow-step">é€‰æ‹©è§†é¢‘</div>
            <div class="flow-step">è·å–è¯¦æƒ…</div>
            <div class="flow-step">é€‰æ‹©å‰§é›†</div>
            <div class="flow-step">è·å–æ’­æ”¾åœ°å€</div>
        </div>
    </div>

    <!-- æ­¥éª¤1ï¼šè·å–ç­›é€‰æ•°æ® -->
    <div class="container">
        <div class="step">
            <h3>æ­¥éª¤1ï¼šè·å–ç­›é€‰æ•°æ®</h3>
            <div class="form-group">
                <label for="filterChannelId">é¢‘é“IDï¼š</label>
                <select id="filterChannelId">
                    <option value="64">çŸ­å‰§ (64)</option>
                    <option value="63">ç”µå½± (63)</option>
                    <option value="65">ç»¼è‰º (65)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="filterIds">ç­›é€‰æ¡ä»¶ (æ’åº,åˆ†ç±»,åœ°åŒº,è¯­è¨€,å¹´ä»½,çŠ¶æ€)ï¼š</label>
                <input type="text" id="filterIds" value="0,0,0,0,0,0" placeholder="ä¾‹å¦‚ï¼š1,0,0,0,0,0">
            </div>
            <div class="form-group">
                <label for="filterPage">é¡µç ï¼š</label>
                <input type="number" id="filterPage" value="1" min="1">
            </div>
            <button onclick="getFilterData()">ğŸ” è·å–ç­›é€‰æ•°æ®</button>
            <div id="filterResult" class="result"></div>
        </div>
    </div>

    <!-- æ­¥éª¤2ï¼šé€‰æ‹©è§†é¢‘ -->
    <div class="container">
        <div class="step">
            <h3>æ­¥éª¤2ï¼šé€‰æ‹©è§†é¢‘</h3>
            <p>ä»ä¸Šé¢çš„ç­›é€‰ç»“æœä¸­é€‰æ‹©ä¸€ä¸ªè§†é¢‘ï¼š</p>
            <div id="videoList"></div>
            <div id="selectedVideo" class="result"></div>
        </div>
    </div>

    <!-- æ­¥éª¤3ï¼šè·å–è§†é¢‘è¯¦æƒ… -->
    <div class="container">
        <div class="step">
            <h3>æ­¥éª¤3ï¼šè·å–è§†é¢‘è¯¦æƒ…</h3>
            <button onclick="getVideoDetails()" id="getDetailsBtn" disabled>ğŸ“‹ è·å–è§†é¢‘è¯¦æƒ…</button>
            <div id="detailsResult" class="result"></div>
        </div>
    </div>

    <!-- æ­¥éª¤4ï¼šé€‰æ‹©å‰§é›† -->
    <div class="container">
        <div class="step">
            <h3>æ­¥éª¤4ï¼šé€‰æ‹©å‰§é›†</h3>
            <p>ä»è§†é¢‘è¯¦æƒ…ä¸­é€‰æ‹©è¦æ’­æ”¾çš„å‰§é›†ï¼š</p>
            <div id="episodeList"></div>
            <div id="selectedEpisode" class="result"></div>
        </div>
    </div>

    <!-- æ­¥éª¤5ï¼šè·å–æ’­æ”¾åœ°å€ -->
    <div class="container">
        <div class="step">
            <h3>æ­¥éª¤5ï¼šè·å–æ’­æ”¾åœ°å€</h3>
            <button onclick="getPlayUrl()" id="getPlayUrlBtn" disabled>ğŸ¬ è·å–æ’­æ”¾åœ°å€</button>
            <div id="playUrlResult" class="result"></div>
        </div>
    </div>

    <!-- å®‰å…¨åˆ†æ -->
    <div class="container">
        <div class="step">
            <h3>ğŸ” å®‰å…¨åˆ†æ</h3>
            <div id="securityAnalysis" class="result">
ç­‰å¾…æ“ä½œå®Œæˆåæ˜¾ç¤ºå®‰å…¨åˆ†æ...
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001/api';
        let selectedVideo = null;
        let selectedEpisode = null;
        let securitySteps = [];

        // æœ‰æ•ˆçš„JWTä»¤ç‰Œï¼ˆç”¨äºæµ‹è¯•ï¼‰
        const mockJWT = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI3ODQ1MDc4ODQ0IiwiaWF0IjoxNzU0NDExNDYxLCJleHAiOjE3NTUwMTYyNjF9.tvs3YYLBhwjAqTwIxS3SznlINBbFz_aNR98P2fRDodI';

        // é€šç”¨APIè°ƒç”¨å‡½æ•°
        async function apiCall(url, options = {}) {
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${mockJWT}`
                }
            };
            
            const response = await fetch(url, {
                ...defaultOptions,
                ...options,
                headers: {
                    ...defaultOptions.headers,
                    ...options.headers
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            return response.json();
        }

        // æ­¥éª¤1ï¼šè·å–ç­›é€‰æ•°æ®
        async function getFilterData() {
            try {
                const channelId = document.getElementById('filterChannelId').value;
                const ids = document.getElementById('filterIds').value;
                const page = document.getElementById('filterPage').value;
                
                securitySteps.push(`ğŸ” ä½¿ç”¨JWTä»¤ç‰Œè¿›è¡Œèº«ä»½éªŒè¯`);
                securitySteps.push(`ğŸ“Š è¯·æ±‚ç­›é€‰æ•°æ® - é¢‘é“:${channelId}, æ¡ä»¶:${ids}, é¡µç :${page}`);
                
                const categoryMap = {
                    '64': 'drama',
                    '63': 'movie', 
                    '65': 'variety'
                };
                
                const params = new URLSearchParams({
                    titleid: categoryMap[channelId],
                    ids: ids,
                    page: page,
                    size: '10'
                });
                
                const data = await apiCall(`${API_BASE}/list/getconditionfilterdata?${params}`, {
                    method: 'GET'
                });
                
                document.getElementById('filterResult').textContent = JSON.stringify(data, null, 2);
                document.getElementById('filterResult').className = 'result success';
                
                // æ˜¾ç¤ºè§†é¢‘åˆ—è¡¨
                displayVideoList(data.data.list);
                
                securitySteps.push(`âœ… æˆåŠŸè·å–${data.data.list.length}ä¸ªè§†é¢‘çš„å…ƒæ•°æ®`);
                securitySteps.push(`ğŸ”’ æ³¨æ„ï¼šæ­¤é˜¶æ®µåªè¿”å›åŸºæœ¬ä¿¡æ¯ï¼Œä¸åŒ…å«æ’­æ”¾åœ°å€`);
                
            } catch (error) {
                document.getElementById('filterResult').textContent = `é”™è¯¯: ${error.message}`;
                document.getElementById('filterResult').className = 'result error';
                securitySteps.push(`âŒ ç­›é€‰æ•°æ®è·å–å¤±è´¥: ${error.message}`);
            }
            
            updateSecurityAnalysis();
        }

        // æ˜¾ç¤ºè§†é¢‘åˆ—è¡¨
        function displayVideoList(videos) {
            const videoList = document.getElementById('videoList');
            videoList.innerHTML = '';
            
            videos.forEach(video => {
                const videoItem = document.createElement('div');
                videoItem.className = 'video-item';
                videoItem.innerHTML = `
                    <strong>${video.title}</strong><br>
                    <small>ID: ${video.id} | UUID: ${video.uuid || 'æœªè®¾ç½®'}</small><br>
                    <small>è¯„åˆ†: ${video.score} | æ’­æ”¾: ${video.playCount}æ¬¡</small>
                `;
                
                videoItem.onclick = () => selectVideo(video, videoItem);
                videoList.appendChild(videoItem);
            });
        }

        // é€‰æ‹©è§†é¢‘
        function selectVideo(video, element) {
            // æ¸…é™¤ä¹‹å‰çš„é€‰æ‹©
            document.querySelectorAll('.video-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // é€‰æ‹©å½“å‰è§†é¢‘
            element.classList.add('selected');
            selectedVideo = video;
            
            document.getElementById('selectedVideo').textContent = JSON.stringify(video, null, 2);
            document.getElementById('selectedVideo').className = 'result success';
            document.getElementById('getDetailsBtn').disabled = false;
            
            securitySteps.push(`ğŸ¯ é€‰æ‹©è§†é¢‘: ${video.title}`);
            securitySteps.push(`ğŸ”‘ å‡†å¤‡ä½¿ç”¨${video.uuid ? 'UUID' : 'ID'}è·å–è¯¦æƒ…`);
            updateSecurityAnalysis();
        }

        // æ­¥éª¤3ï¼šè·å–è§†é¢‘è¯¦æƒ…
        async function getVideoDetails() {
            if (!selectedVideo) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§†é¢‘');
                return;
            }
            
            try {
                const identifier = selectedVideo.uuid || selectedVideo.id;
                const paramName = selectedVideo.uuid ? 'uuid' : 'id';
                
                securitySteps.push(`ğŸ” ä½¿ç”¨${paramName.toUpperCase()}è·å–è¯¦æƒ…: ${identifier}`);
                
                const data = await apiCall(`${API_BASE}/video/details?${paramName}=${identifier}`);
                
                document.getElementById('detailsResult').textContent = JSON.stringify(data, null, 2);
                document.getElementById('detailsResult').className = 'result success';
                
                // æ˜¾ç¤ºå‰§é›†åˆ—è¡¨
                if (data.data && data.data.detailInfo && data.data.detailInfo.episodes) {
                    displayEpisodeList(data.data.detailInfo.episodes);
                    securitySteps.push(`ğŸ“º è·å–åˆ°${data.data.detailInfo.episodes.length}ä¸ªå‰§é›†ä¿¡æ¯`);
                    securitySteps.push(`ğŸ” æ¯ä¸ªå‰§é›†éƒ½æœ‰ç‹¬ç«‹çš„è®¿é—®å¯†é’¥ä¿æŠ¤`);
                }
                
            } catch (error) {
                document.getElementById('detailsResult').textContent = `é”™è¯¯: ${error.message}`;
                document.getElementById('detailsResult').className = 'result error';
                securitySteps.push(`âŒ è§†é¢‘è¯¦æƒ…è·å–å¤±è´¥: ${error.message}`);
            }
            
            updateSecurityAnalysis();
        }

        // æ˜¾ç¤ºå‰§é›†åˆ—è¡¨
        function displayEpisodeList(episodes) {
            const episodeList = document.getElementById('episodeList');
            episodeList.innerHTML = '';
            
            episodes.forEach(episode => {
                const episodeItem = document.createElement('div');
                episodeItem.className = 'episode-item';
                episodeItem.innerHTML = `
                    <strong>ç¬¬${episode.episodeTitle}é›†</strong><br>
                    <small>å‰§é›†ID: ${episode.episodeId}</small><br>
                    <small>æ—¶é•¿: ${episode.epSecond}ç§’</small><br>
                    <small>ğŸ”‘ è®¿é—®å¯†é’¥: ${episode.accessKey || 'éœ€è¦ç”Ÿæˆ'}</small>
                `;
                
                episodeItem.onclick = () => selectEpisode(episode, episodeItem);
                episodeList.appendChild(episodeItem);
            });
        }

        // é€‰æ‹©å‰§é›†
        function selectEpisode(episode, element) {
            // æ¸…é™¤ä¹‹å‰çš„é€‰æ‹©
            document.querySelectorAll('.episode-item').forEach(item => {
                item.style.backgroundColor = '#f8f9fa';
            });
            
            // é€‰æ‹©å½“å‰å‰§é›†
            element.style.backgroundColor = '#e3f2fd';
            selectedEpisode = episode;
            
            document.getElementById('selectedEpisode').textContent = JSON.stringify(episode, null, 2);
            document.getElementById('selectedEpisode').className = 'result success';
            document.getElementById('getPlayUrlBtn').disabled = !episode.accessKey;
            
            securitySteps.push(`ğŸ¬ é€‰æ‹©å‰§é›†: ç¬¬${episode.episodeTitle}é›†`);
            if (episode.accessKey) {
                securitySteps.push(`ğŸ”‘ è·å–åˆ°è®¿é—®å¯†é’¥: ${episode.accessKey}`);
            } else {
                securitySteps.push(`âš ï¸ è¯¥å‰§é›†ç¼ºå°‘è®¿é—®å¯†é’¥ï¼Œæ— æ³•è·å–æ’­æ”¾åœ°å€`);
            }
            updateSecurityAnalysis();
        }

        // æ­¥éª¤5ï¼šè·å–æ’­æ”¾åœ°å€
        async function getPlayUrl() {
            if (!selectedEpisode || !selectedEpisode.accessKey) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæœ‰è®¿é—®å¯†é’¥çš„å‰§é›†');
                return;
            }
            
            try {
                securitySteps.push(`ğŸ” ä½¿ç”¨è®¿é—®å¯†é’¥è¯·æ±‚æ’­æ”¾åœ°å€`);
                securitySteps.push(`ğŸ” éªŒè¯å¯†é’¥æ ¼å¼: ${selectedEpisode.accessKey}`);
                
                const data = await apiCall(`${API_BASE}/video/episode-url/${selectedEpisode.accessKey}`);
                
                document.getElementById('playUrlResult').textContent = JSON.stringify(data, null, 2);
                document.getElementById('playUrlResult').className = 'result success';
                
                securitySteps.push(`âœ… æˆåŠŸè·å–æ’­æ”¾åœ°å€`);
                securitySteps.push(`ğŸ¯ CDNåœ°å€: ${data.cdnUrl}`);
                securitySteps.push(`ğŸ’¾ OSSå¤‡ä»½: ${data.ossUrl}`);
                if (data.subtitleUrl) {
                    securitySteps.push(`ğŸ“ å­—å¹•åœ°å€: ${data.subtitleUrl}`);
                }
                
            } catch (error) {
                document.getElementById('playUrlResult').textContent = `é”™è¯¯: ${error.message}`;
                document.getElementById('playUrlResult').className = 'result error';
                securitySteps.push(`âŒ æ’­æ”¾åœ°å€è·å–å¤±è´¥: ${error.message}`);
            }
            
            updateSecurityAnalysis();
        }

        // æ›´æ–°å®‰å…¨åˆ†æ
        function updateSecurityAnalysis() {
            const analysis = document.getElementById('securityAnalysis');
            let content = 'ğŸ”’ å®‰å…¨æµç¨‹åˆ†æ:\n\n';
            
            securitySteps.forEach((step, index) => {
                content += `${index + 1}. ${step}\n`;
            });
            
            content += '\nğŸ›¡ï¸ å®‰å…¨ç‰¹æ€§æ€»ç»“:\n';
            content += 'â€¢ JWTèº«ä»½éªŒè¯ï¼šé˜²æ­¢æœªæˆæƒè®¿é—®\n';
            content += 'â€¢ UUIDæ ‡è¯†ç¬¦ï¼šé˜²æ­¢IDæšä¸¾æ”»å‡»\n';
            content += 'â€¢ è®¿é—®å¯†é’¥ï¼šæ’­æ”¾åœ°å€äºŒæ¬¡ä¿æŠ¤\n';
            content += 'â€¢ åˆ†å±‚è®¿é—®ï¼šå…ƒæ•°æ®ä¸èµ„æºåˆ†ç¦»\n';
            content += 'â€¢ ç¼“å­˜ç­–ç•¥ï¼šæé«˜æ€§èƒ½åŒæ—¶ä¿è¯å®‰å…¨\n';
            
            analysis.textContent = content;
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateSecurityAnalysis();
        });
    </script>
</body>
</html>