# Ingest API 项目说明

## 🎯 项目概述

Ingest API 是短剧系统的核心数据采集接口，提供完整的系列、剧集和播放地址管理功能。经过深入调试和优化，现已完全可用。

## ✨ 主要功能

- **单个系列入库**: 创建或更新单个系列及其剧集信息
- **批量系列入库**: 批量处理多个系列数据
- **增量更新**: 基于 externalId 智能更新已有系列
- **智能字段处理**: 只更新提供的字段，支持备选值获取
- **自动清理机制**: 支持清理不再需要的剧集和URL
- **AccessKey生成**: 自动为每个URL生成唯一访问密钥
- **Short ID管理**: 系统自动分配唯一系列标识符
- **External ID管理**: 支持业务语义的标识符设计

## 🔑 核心概念

### External ID 系统
- **用途**: 外部系统的唯一业务标识符，用于数据同步和关联
- **格式**: 字符串，建议使用有意义的业务标识
- **生成规则**: 由外部系统或业务方定义，确保在业务域内唯一
- **使用场景**: 数据同步、增量更新、跨系统关联、业务追踪
- **特点**: 业务语义明确，便于理解和维护

### Short ID 系统
- **用途**: 为每个系列生成唯一的短标识符
- **格式**: 4位数字，如 "1001", "2005"
- **生成规则**: 系统自动分配，确保唯一性
- **使用场景**: 内部系统引用、URL路径、数据库关联

### Access Key 系统
- **用途**: 为每个播放地址生成唯一的访问密钥
- **格式**: 32位十六进制字符串，如 "458ce373ef70440061d0a50a569b09d3"
- **生成规则**: 基于 `externalId + episodeNumber + quality` 的MD5哈希
- **使用场景**: 播放地址访问、防盗链、统计分析
- **特点**: 确定性生成，相同参数总是生成相同的key

## 🚀 快速开始

### 1. 启动服务
```bash
# 构建项目
npm run build

# 启动开发服务
npm run start:dev
```

### 2. 运行测试
```bash
# 运行完整测试
node scripts/test-ingest-api.js
```

### 3. 手动测试
```bash
# 测试单个系列入库
curl -X POST http://localhost:8080/api/admin/ingest/series \
  -H "Content-Type: application/json" \
  -d @scripts/ingest-test-examples.json
```

## 📚 文档

- **[完整API指南](docs/ingest-api-complete-guide.md)**: 超级详细的API使用说明
- **[测试示例](scripts/ingest-test-examples.json)**: 包含所有接口的测试数据
- **[测试脚本](scripts/test-ingest-api.js)**: 自动化测试工具

## 🔧 技术架构

- **框架**: NestJS
- **数据库**: TypeORM + MySQL
- **验证**: class-validator + class-transformer
- **语言**: TypeScript

## 📊 测试状态

| 功能 | 状态 | 说明 |
|------|------|------|
| 单个系列入库 | ✅ 完全工作 | 支持完整字段和最小化字段 |
| 批量系列入库 | ✅ 完全工作 | 支持大量数据处理 |
| 增量更新 | ✅ 完全工作 | 支持剧集和URL的增删改 |
| 错误处理 | ✅ 完全工作 | 完善的参数验证和错误提示 |
| 性能优化 | ✅ 完全工作 | 支持批量操作和智能更新 |
| Short ID生成 | ✅ 完全工作 | 自动分配唯一标识符 |
| Access Key生成 | ✅ 完全工作 | 确定性哈希生成算法 |
| External ID管理 | ✅ 完全工作 | 支持业务语义标识符 |

## 🎉 问题解决

### 主要问题
- **originUrl字段缺失**: 数据库约束要求NOT NULL，代码中未提供该字段

### 解决方案
- 在创建URL实体时添加 `originUrl: u.originUrl ?? (u.ossUrl ?? '')`
- 确保所有必需字段都有值或备选值

### 调试过程
1. 逐步测试各个功能模块
2. 添加详细日志输出
3. 定位具体错误原因
4. 修复代码问题
5. 验证所有功能正常工作

## 💡 使用建议

### 1. 数据准备
- 确保 `externalId` 唯一
- 提供完整的URL信息（ossUrl, cdnUrl, originUrl）
- 验证必填字段完整性

### 2. 性能优化
- 使用批量接口处理大量数据
- 优先使用增量更新而不是重新创建
- 合理设置并发请求数

### 3. 错误处理
- 检查网络连接和API状态
- 验证请求数据格式
- 查看服务器日志获取详细错误信息

### 4. ID和Key管理
- **Short ID**: 系统自动生成，不要手动修改或依赖特定值
- **Access Key**: 基于参数确定性生成，支持跨系统同步
- **externalId**: 建议使用有意义的业务标识符

### 5. External ID设计
- **命名规范**: 使用统一的命名规范，如 `{业务类型}-{年份}-{序号}`
- **业务语义**: 确保ID具有明确的业务含义
- **扩展性**: 考虑未来业务增长，预留扩展空间
- **稳定性**: 一旦分配，避免随意修改
- **唯一性**: 在业务域内确保全局唯一

## 🔗 相关链接

- **API文档**: [docs/ingest-api-complete-guide.md](docs/ingest-api-complete-guide.md)
- **测试数据**: [scripts/ingest-test-examples.json](scripts/ingest-test-examples.json)
- **测试脚本**: [scripts/test-ingest-api.js](scripts/test-ingest-api.js)

## 📞 技术支持

如遇到问题，请：
1. 查看完整API文档
2. 运行测试脚本验证功能
3. 检查请求数据和响应
4. 联系开发团队

---

**项目状态**: ✅ 生产就绪  
**最后更新**: 2025-08-29  
**维护团队**: 短剧系统开发团队
